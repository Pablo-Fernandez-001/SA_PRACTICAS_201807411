############################################################################
# DeliverEats — docker-compose.yml
# Orquestación completa: 4 DBs aisladas + 4 micro-servicios + API Gateway + Frontend
# gRPC: catalog-service (server :50052)  ←  orders-service (client)
############################################################################

services:

  # ═══════════════════════════════════════════════════════════════════════════
  # DATABASES — Aislamiento de persistencia (cada servicio su propia BD)
  # ═══════════════════════════════════════════════════════════════════════════

  auth-db:
    image: mysql:8.0
    container_name: delivereats-auth-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: auth_db
      MYSQL_ROOT_HOST: '%'
    ports:
      - "3306:3306"
    volumes:
      - auth_db_data:/var/lib/mysql
      - ./db/auth_db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - delivereats-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-ppassword"]
      timeout: 20s
      retries: 10
      interval: 10s
      start_period: 40s

  catalog-db:
    image: mysql:8.0
    container_name: delivereats-catalog-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: catalog_db
      MYSQL_ROOT_HOST: '%'
    ports:
      - "3307:3306"
    volumes:
      - catalog_db_data:/var/lib/mysql
      - ./db/catalog_db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - delivereats-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-ppassword"]
      timeout: 20s
      retries: 10
      interval: 10s
      start_period: 40s

  orders-db:
    image: mysql:8.0
    container_name: delivereats-orders-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: orders_db
      MYSQL_ROOT_HOST: '%'
    ports:
      - "3308:3306"
    volumes:
      - orders_db_data:/var/lib/mysql
      - ./db/orders_db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - delivereats-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-ppassword"]
      timeout: 20s
      retries: 10
      interval: 10s
      start_period: 40s

  delivery-db:
    image: mysql:8.0
    container_name: delivereats-delivery-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: delivery_db
      MYSQL_ROOT_HOST: '%'
    ports:
      - "3309:3306"
    volumes:
      - delivery_db_data:/var/lib/mysql
      - ./db/delivery_db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - delivereats-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-ppassword"]
      timeout: 20s
      retries: 10
      interval: 10s
      start_period: 40s

  # ═══════════════════════════════════════════════════════════════════════════
  # MICROSERVICES
  # ═══════════════════════════════════════════════════════════════════════════

  auth-service:
    build:
      context: .
      dockerfile: ./auth-service/Dockerfile
    container_name: delivereats-auth-service
    restart: unless-stopped
    env_file:
      - ./auth-service/.env.docker
    ports:
      - "50051:50051"
    depends_on:
      auth-db:
        condition: service_healthy
    networks:
      - delivereats-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "50051"]
      timeout: 10s
      retries: 10
      interval: 10s
      start_period: 60s

  catalog-service:
    build:
      context: .
      dockerfile: ./catalog-service/Dockerfile
    container_name: delivereats-catalog-service
    restart: unless-stopped
    env_file:
      - ./catalog-service/.env.docker
    ports:
      - "3002:3002"
      - "50052:50052"
    depends_on:
      catalog-db:
        condition: service_healthy
    networks:
      - delivereats-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3002/health"]
      timeout: 10s
      retries: 10
      interval: 10s
      start_period: 60s

  orders-service:
    build:
      context: .
      dockerfile: ./orders-service/Dockerfile
    container_name: delivereats-orders-service
    restart: unless-stopped
    env_file:
      - ./orders-service/.env.docker
    ports:
      - "3003:3003"
    depends_on:
      orders-db:
        condition: service_healthy
      catalog-service:
        condition: service_healthy
    networks:
      - delivereats-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3003/health"]
      timeout: 10s
      retries: 10
      interval: 10s
      start_period: 60s

  delivery-service:
    build:
      context: .
      dockerfile: ./delivery-service/Dockerfile
    container_name: delivereats-delivery-service
    restart: unless-stopped
    env_file:
      - ./delivery-service/.env.docker
    ports:
      - "3004:3004"
    depends_on:
      delivery-db:
        condition: service_healthy
    networks:
      - delivereats-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3004/health"]
      timeout: 10s
      retries: 10
      interval: 10s
      start_period: 60s

  notification-service:
    build:
      context: .
      dockerfile: ./notification-service/Dockerfile
    container_name: delivereats-notification-service
    restart: unless-stopped
    env_file:
      - ./notification-service/.env.docker
    ports:
      - "3005:3005"
    networks:
      - delivereats-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3005/health"]
      timeout: 10s
      retries: 10
      interval: 10s
      start_period: 30s

  # ═══════════════════════════════════════════════════════════════════════════
  # API GATEWAY
  # ═══════════════════════════════════════════════════════════════════════════

  api-gateway:
    build:
      context: .
      dockerfile: ./api-gateway/Dockerfile
    container_name: delivereats-api-gateway
    restart: unless-stopped
    env_file:
      - ./api-gateway/.env.docker
    ports:
      - "8080:8080"
    depends_on:
      auth-service:
        condition: service_healthy
      catalog-service:
        condition: service_healthy
      orders-service:
        condition: service_healthy
      delivery-service:
        condition: service_healthy
    networks:
      - delivereats-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      timeout: 10s
      retries: 10
      interval: 10s
      start_period: 60s

  # ═══════════════════════════════════════════════════════════════════════════
  # FRONTEND
  # ═══════════════════════════════════════════════════════════════════════════

  frontend:
    build:
      context: .
      dockerfile: ./frontend/Dockerfile
    container_name: delivereats-frontend
    restart: unless-stopped
    environment:
      - VITE_API_URL=http://34.55.27.36:8080/api
    ports:
      - "3000:3000"
    depends_on:
      api-gateway:
        condition: service_healthy
    networks:
      - delivereats-network

# ═══════════════════════════════════════════════════════════════════════════════
# VOLUMES & NETWORKS
# ═══════════════════════════════════════════════════════════════════════════════

volumes:
  auth_db_data:
    name: delivereats_auth_db_data
  catalog_db_data:
    name: delivereats_catalog_db_data
  orders_db_data:
    name: delivereats_orders_db_data
  delivery_db_data:
    name: delivereats_delivery_db_data

networks:
  delivereats-network:
    name: delivereats-network
    driver: bridge